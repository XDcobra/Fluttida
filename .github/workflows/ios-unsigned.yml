name: iOS unsigned build (.app + pseudo .ipa)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build-ios-unsigned:
    runs-on: macos-14

    defaults:
      run:
        working-directory: example_app/fluttida

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Flutter setup
      # ------------------------------------------------------------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Pub get
        run: flutter pub get

      # ------------------------------------------------------------
      # 1) Flutter config only (Pods + Xcode project, NO build)
      # ------------------------------------------------------------
      - name: Flutter iOS config only
        run: flutter build ios --config-only --no-codesign

      # ------------------------------------------------------------
      # 2) Xcode warm-up build (creates Release-iphoneos + privacy bundles)
      #    IMPORTANT: no Flutter build here
      # ------------------------------------------------------------
      - name: Xcode warm-up build (no codesign)
        run: |
          cd ios
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            build

      # ------------------------------------------------------------
      # 3) Xcode 15 privacy bundle workaround (generic, all plugins)
      # ------------------------------------------------------------
      - name: Inject dummy privacy binaries (Xcode 15 workaround)
        run: |
          ROOT="build/ios/Release-iphoneos"

          echo "Scanning for *_privacy.bundle directories..."
          find "$ROOT" -type d -name "*_privacy.bundle" | while read BUNDLE; do
            NAME="$(basename "$BUNDLE" | sed 's/_privacy.bundle//')"
            BIN="$BUNDLE/${NAME}_privacy"

            echo "Fixing: $BIN"
            if [ ! -f "$BIN" ]; then
              touch "$BIN"
              chmod +x "$BIN"
            fi

            ls -la "$BUNDLE"
            echo "-----------------------------"
          done

      # ------------------------------------------------------------
      # 4) FINAL Flutter build (unsigned, exactly once)
      # ------------------------------------------------------------
      - name: Final Flutter build (release, unsigned)
        run: flutter build ios --release --no-codesign

      # ------------------------------------------------------------
      # 5) Create unsigned IPA from Runner.app
      # ------------------------------------------------------------
      - name: Create unsigned IPA
        run: |
          APP_DIR="build/ios/iphoneos/Runner.app"

          if [ ! -d "$APP_DIR" ]; then
            echo "Runner.app not found!"
            ls -la build/ios/iphoneos || true
            exit 1
          fi

          mkdir -p build/ios/ipa/Payload
          rm -rf build/ios/ipa/Payload/*

          cp -R "$APP_DIR" build/ios/ipa/Payload/Runner.app

          cd build/ios/ipa
          zip -r Fluttida-unsigned.ipa Payload
          cd -

      # ------------------------------------------------------------
      # 6) Upload artifacts
      # ------------------------------------------------------------
      - name: Upload Runner.app
        uses: actions/upload-artifact@v4
        with:
          name: Fluttida-Runner-app
          path: example_app/fluttida/build/ios/iphoneos/Runner.app

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: Fluttida-unsigned-ipa
          path: example_app/fluttida/build/ios/ipa/Fluttida-unsigned.ipa
